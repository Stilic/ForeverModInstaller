version: 2.1

orbs:
  win: circleci/windows@2.2.0

workflows:
  main:
    jobs:
      - build
      - publish-github-release


jobs:
  build:
    executor:
      name: win/default
      shell: cmd.exe
    steps:
      - checkout
      - run:
          name: "Install Python"
          command: choco install python --version=3.9.5
      - run:
          name: "Install Deps"
          command: python -m pip install --user -r requirements.txt
      - run:
          name: "Build"
          command: pyinstaller --noconfirm --onefile --name "fmi" main.py && pyinstaller --noconfirm --onefile registerProtocol.py && pyinstaller --noconfirm --onefile removeProtocol.py
  publish-github-release:
    docker:
      - image: circleci/golang:1.12
    steps:
      - attach_workspace:
          at: ./dist
      - run:
          name: "Publish Release on GitHub"
          command: |
            go get github.com/tcnksm/ghr
            CIRCLE_TAG="$(git tag -l --points-at HEAD)" ghr -t ${GITHUB_TOKEN} -u ${CIRCLE_PROJECT_USERNAME} -r ${CIRCLE_PROJECT_REPONAME} -delete ${VERSION} ${CIRCLE_TAG} ./dist/
